<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spendy | Pay Bills</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- UNIFIED THEME VARIABLES --- */
        :root {
            --cosmic-bg: #0a0a0f; --cosmic-surface: rgba(26, 26, 46, 0.25); --cosmic-card: #16213e;
            --cosmic-purple: #7c3aed; --cosmic-teal: #14b8a6; --cosmic-text: #e2e8f0; --cosmic-muted: #94a3b8;
            --cosmic-border: rgba(124, 58, 237, 0.2); --cosmic-success: #22c55e; --cosmic-error: #ef4444; --cosmic-warning: #f97316;
        }
        [data-theme="light"] {
            --cosmic-bg: #87CEEB; --cosmic-surface: rgba(255, 255, 255, 0.5); --cosmic-card: #ffffff;
            --cosmic-purple: #8b5cf6; --cosmic-teal: #0d9488; --cosmic-text: #1e293b; --cosmic-muted: #64748b;
            --cosmic-border: rgba(139, 92, 246, 0.2);
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--cosmic-bg); 
            color: var(--cosmic-text); 
            transition: background-color 0.8s ease, color 0.3s ease; 
            overflow-x: hidden; 
        }
        
        /* --- DUAL THEME BACKGROUND STYLES --- */
        #background-container > div { position: fixed; transition: opacity 0.8s ease-in-out; pointer-events: none; z-index: -2; }
        
        /* Dark Mode Elements */
        .starfield, .moon, .shooting-stars { opacity: 1; }
        .starfield { top: 0; left: 0; width: 100%; height: 200%; animation: slide-stars 200s linear infinite; }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 3s infinite; }
        
        .moon {
            top: 2rem; right: 2rem; width: 60px; height: 60px; border-radius: 50%;
            background-color: #E0E0E0;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(0,0,0,0.25) 0%, transparent 25%),
                radial-gradient(circle at 65% 70%, rgba(0,0,0,0.2) 0%, transparent 20%),
                radial-gradient(circle at 45% 55%, rgba(255,255,255,0.1) 0%, transparent 15%);
            box-shadow: 0 0 15px #ffffff, 0 0 30px rgba(255,255,255,0.7);
            animation: float-celestial 60s ease-in-out infinite alternate;
        }

        .shooting-stars { top:0; left:0; width: 100%; height: 100%; }
        .shooting-star { position: absolute; width: 2px; height: 2px; background: white; border-radius: 50%; box-shadow: 0 0 10px #fff, 0 0 20px #fff; animation: shoot linear infinite; }
        .shooting-star::before { content: ''; position: absolute; width: 200px; height: 1px; background: linear-gradient(90deg, #fff, transparent); transform: translateX(-100%) translateY(-50%); }
        @keyframes slide-stars { from { transform: translateY(0); } to { transform: translateY(-50%); } }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        @keyframes float-celestial { from { transform: translate(-20px, 10px); } to { transform: translate(20px, -10px); } }
        @keyframes shoot { from { transform: translate(var(--start-x), var(--start-y)) scale(0); } to { transform: translate(var(--end-x), var(--end-y)) scale(1); opacity: 0; } }

        /* Light Mode Elements */
        .sun-sky, .clouds { opacity: 0; }
        .sun-sky {
            top: 2rem; right: 2rem; width: 60px; height: 60px; background: #FFD700; border-radius: 50%;
            box-shadow: 0 0 25px #FFD700, 0 0 50px #FFD700;
            animation: pulse-sun 5s ease-in-out infinite;
        }
        .cloud { position: absolute; background: rgba(255, 255, 255, 0.8); border-radius: 50%; width: 150px; height: 50px; animation: drift 60s linear infinite; }
        .cloud:before, .cloud:after { content: ''; position: absolute; background: rgba(255, 255, 255, 0.8); border-radius: 50%; }
        .cloud:before { width: 80px; height: 80px; top: -40px; left: 20px; }
        .cloud:after { width: 100px; height: 60px; top: -30px; right: 20px; }
        #cloud1 { top: 20%; animation-duration: 70s; } #cloud2 { top: 50%; animation-duration: 90s; animation-delay: -20s; } #cloud3 { top: 70%; animation-duration: 60s; animation-delay: -40s; }
        @keyframes pulse-sun { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes drift { from { transform: translateX(-200px); } to { transform: translateX(100vw); } }

        /* Theme Toggle Logic */
        [data-theme="light"] .starfield, [data-theme="light"] .moon, [data-theme="light"] .shooting-stars { opacity: 0; }
        [data-theme="light"] .sun-sky, [data-theme="light"] .clouds { opacity: 1; }
        
        /* --- GENERAL & COMPONENT STYLES --- */
        .orbitron { font-family: 'Orbitron', monospace; }
        .card { background-color: var(--cosmic-surface); border: 1px solid var(--cosmic-border); border-radius: 20px; padding: 1.5rem; backdrop-filter: blur(20px); position: relative; overflow: hidden; color: var(--cosmic-text); }
        .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--cosmic-purple), var(--cosmic-teal), transparent); }
        .btn-primary { background: linear-gradient(135deg, var(--cosmic-purple), var(--cosmic-teal)); color: white; border: none; border-radius: 12px; font-weight: 600; padding: 0.75rem 1.5rem; transition: all 0.3s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(124, 58, 237, 0.4); }
        .btn-secondary { background: rgba(124, 58, 237, 0.1); color: var(--cosmic-purple); border-radius: 999px; font-weight: 600; padding: 0.5rem 1rem; transition: all 0.3s ease; font-size: 0.875rem; }
        .btn-secondary:hover { background: var(--cosmic-purple); color: white; transform: translateY(-1px); }
        .input-field { width: 100%; background-color: var(--cosmic-card); border: 1px solid var(--cosmic-border); color: var(--cosmic-text); border-radius: 12px; padding: 0.75rem 1rem; transition: all 0.3s ease; }
        .input-field:focus { outline: none; border-color: var(--cosmic-purple); box-shadow: 0 0 20px rgba(124, 58, 237, 0.3); }
        .balance-card { background: linear-gradient(135deg, #be185d, #9d174d); border-radius: 20px; padding: 2rem; color: white; box-shadow: 0 20px 40px rgba(190, 24, 93, 0.3); animation: subtle-float 6s ease-in-out infinite; }
        @keyframes subtle-float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-8px); } }
        .nav-container { background: var(--cosmic-surface); backdrop-filter: blur(20px); border-bottom: 1px solid var(--cosmic-border); }
        .nav-item { color: var(--cosmic-muted); transition: all 0.3s ease; border-radius: 12px; }
        .nav-item:hover { color: var(--cosmic-text); background: rgba(124, 58, 237, 0.1); }
        .nav-item.active { background: linear-gradient(135deg, var(--cosmic-purple), var(--cosmic-teal)); color: white; }
        .theme-toggle { width: 50px; height: 26px; background: var(--cosmic-card); border: 1px solid var(--cosmic-border); border-radius: 13px; position: relative; cursor: pointer; }
        .theme-toggle::before { content: 'üåô'; position: absolute; top: 2px; left: 3px; width: 20px; height: 20px; background: var(--cosmic-purple); border-radius: 50%; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        [data-theme="light"] .theme-toggle::before { content: '‚òÄÔ∏è'; transform: translateX(23px); }
        .message-box { display: flex; align-items: center; gap: 1rem; position: fixed; top: -100px; left: 50%; transform: translateX(-50%); padding: 1rem 1.5rem; border-radius: 12px; color: white; z-index: 1000; transition: top 0.5s ease; backdrop-filter: blur(10px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .message-box.show { top: 2rem; }
        .message-box.success { background: linear-gradient(135deg, var(--cosmic-success), #16a34a); }
        .message-box button { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); border-radius: 8px; padding: 0.25rem 0.75rem; font-weight: 600; transition: background-color 0.2s ease; }
        .message-box button:hover { background: rgba(255,255,255,0.3); }
        .tag { background-color: rgba(124, 58, 237, 0.1); color: var(--cosmic-purple); padding: 0.1rem 0.6rem; border-radius: 999px; font-size: 0.7rem; font-weight: 500; display: inline-block; }
        .tab-button { background: none; border: none; padding: 0.5rem 1rem; color: var(--cosmic-muted); font-weight: 600; border-bottom: 2px solid transparent; transition: all 0.3s ease; }
        .tab-button.active { color: var(--cosmic-purple); border-bottom-color: var(--cosmic-purple); }
        .tab-button:hover:not(.active) { color: var(--cosmic-text); }
        dialog[open] .card { animation: slide-up-fade-in 0.3s ease forwards; }
        @keyframes slide-up-fade-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .category-btn { background-color: var(--cosmic-card); border: 1px solid var(--cosmic-border); color: var(--cosmic-muted); border-radius: 999px; padding: 0.5rem 1rem; font-weight: 500; transition: all 0.2s ease; }
        .category-btn.active { border-color: var(--cosmic-purple); color: var(--cosmic-purple); background-color: rgba(124, 58, 237, 0.1); }
        #print-container { display: none; }
        @media print { body * { visibility: hidden; } #print-container, #print-container * { visibility: visible; } #print-container { display: block; position: absolute; left: 0; top: 0; width: 100%; } }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fade-in 0.5s ease forwards; }
    </style>
</head>
<body class="pt-16">
    <div id="background-container">
        <div class="starfield" id="starfield"></div>
        <div class="moon"></div>
        <div class="shooting-stars" id="shooting-stars"></div>
        <div class="sun-sky"></div>
        <div class="clouds">
            <div id="cloud1" class="cloud"></div><div id="cloud2" class="cloud"></div><div id="cloud3" class="cloud"></div>
        </div>
    </div>
    <div id="messageBox" class="message-box"></div>
    <div id="print-container"></div>

    <header class="nav-container fixed w-full top-0 z-50">
       <nav class="max-w-7xl mx-auto px-6">
            <div class="flex items-center justify-between h-16">
                <a href="DashBoard.html" class="text-xl font-bold orbitron bg-gradient-to-r from-purple-400 to-teal-400 bg-clip-text text-transparent">SPENDY</a>
                <div class="desktop-nav flex items-center space-x-2 ml-12">
                    <a href="DashBoard.html"><div class="nav-item flex items-center space-x-2 px-4 py-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg><span class="text-sm font-medium">Home</span></div></a>
                    <a href="Investments.html"><div class="nav-item flex items-center space-x-2 px-4 py-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg><span class="text-sm font-medium">Investments</span></div></a>
                    <a href="Transactions.html"><div class="nav-item flex items-center space-x-2 px-4 py-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg><span class="text-sm font-medium">Transactions</span></div></a>
                    <a href="PayBills.html"><div class="nav-item active flex items-center space-x-2 px-4 py-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg><span class="text-sm font-medium">Pay Bills</span></div></a>
                    <a href="safe.html"><div class="nav-item flex items-center space-x-2 px-4 py-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg><span class="text-sm font-medium">Goals</span></div></a>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="theme-toggle" id="themeToggle"></div>
                    <a href="Profile.html" class="flex items-center space-x-2"><div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-teal-500 rounded-full flex items-center justify-center"><span class="text-white text-sm font-bold orbitron">CS</span></div></a>
                </div>
            </div>
        </nav>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8 relative z-10">
        <div class="grid lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <section class="balance-card fade-in">
                    <div class="text-center">
                        <h2 class="text-lg font-medium opacity-90">Total Upcoming Due</h2>
                        <p class="text-4xl font-bold orbitron mt-1" id="totalDueAmount">‚Çπ0</p>
                    </div>
                </section>
                <section class="card fade-in" style="animation-delay: 0.1s;">
                    <div class="flex items-center justify-between mb-4 border-b" style="border-color: var(--cosmic-border);">
                        <div class="flex items-center" id="billTabs">
                            <button class="tab-button active" data-view="upcoming">Upcoming</button>
                            <button class="tab-button" data-view="history">History</button>
                        </div>
                        <button class="btn-primary mb-2" onclick="billModal.showModal()">Add New Bill</button>
                    </div>
                    <div class="space-y-4" id="billsList"></div>
                </section>
            </div>
            <aside class="space-y-8">
                <section class="card fade-in" style="animation-delay: 0.2s;">
                    <div class="text-center">
                        <svg class="w-12 h-12 mx-auto text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path></svg>
                        <h3 class="text-xl font-semibold mt-4">Rewards Hub</h3>
                        <p class="mt-2" style="color: var(--cosmic-muted);">You have</p>
                        <p class="text-4xl font-bold orbitron text-yellow-400" id="pointsDisplay">0</p>
                        <p class="font-semibold" style="color: var(--cosmic-muted);">Points</p>
                        <a href="Rewards.html" class="block mt-6"><button class="btn-primary w-full">View & Claim Rewards</button></a>
                    </div>
                </section>
            </aside>
        </div>
    </main>

    <dialog id="billModal">
        <div class="card">
            <div class="flex items-center gap-4 mb-6">
                <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background-color: rgba(124, 58, 237, 0.1);"><svg class="w-6 h-6" style="color: var(--cosmic-purple);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div>
                <h3 class="text-xl font-semibold">Add a New Bill</h3>
            </div>
            <form id="billForm" class="space-y-6">
                <div>
                    <label for="billName" class="text-sm font-medium block mb-2" style="color: var(--cosmic-muted);">Biller Name</label>
                    <input type="text" placeholder="e.g., Netflix, Electricity" class="input-field" id="billName" required>
                </div>
                <div>
                    <label class="text-sm font-medium block mb-2" style="color: var(--cosmic-muted);">Category</label>
                    <div class="flex flex-wrap gap-2" id="categoryButtons">
                        <button type="button" class="category-btn" data-value="Subscription">Subscription</button>
                        <button type="button" class="category-btn" data-value="Utilities">Utilities</button>
                        <button type="button" class="category-btn" data-value="Rent">Rent</button>
                        <button type="button" class="category-btn" data-value="Credit Card">Credit Card</button>
                        <button type="button" class="category-btn" data-value="Other">Other</button>
                    </div>
                    <input type="hidden" id="billCategory" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="billAmount" class="text-sm font-medium block mb-2" style="color: var(--cosmic-muted);">Amount</label>
                        <div class="relative"><span class="absolute inset-y-0 left-0 flex items-center pl-3" style="color: var(--cosmic-muted);">‚Çπ</span><input type="number" placeholder="0" class="input-field pl-7" id="billAmount" required min="0" step="1"></div>
                    </div>
                    <div>
                        <label for="billDueDate" class="text-sm font-medium block mb-2" style="color: var(--cosmic-muted);">Due Date</label>
                        <input type="date" class="input-field" id="billDueDate" required>
                    </div>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="btn-primary flex-1">Add Bill</button>
                    <button type="button" class="px-4 py-2 rounded-lg border" style="border-color: var(--cosmic-border); color: var(--cosmic-muted);" id="cancelBillBtn">Cancel</button>
                </div>
            </form>
        </div>
    </dialog>

    <script>
        if (localStorage.getItem('spendyLoggedIn') !== 'true') {
            window.location.href = 'Login.html';
        }
        document.addEventListener('DOMContentLoaded', function() {
            // --- STATE MANAGEMENT ---
            let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            // MODIFIED: Updated default bills to realistic INR values
            let upcomingBills = JSON.parse(localStorage.getItem('upcomingBills')) || [
                { id: 1, name: 'Netflix Premium', amount: 649, dueDate: '2025-09-18T12:00:00Z', category: 'Subscription' },
                { id: 2, name: 'Airtel Fiber', amount: 899, dueDate: '2025-09-23T12:00:00Z', category: 'Utilities' }
            ];
            let paidBills = JSON.parse(localStorage.getItem('paidBills')) || [];
            let userPoints = JSON.parse(localStorage.getItem('userPoints')) || 1250;
            let currentBillView = 'upcoming';
            
            const billModal = document.getElementById('billModal');
            const categoryButtonsContainer = document.getElementById('categoryButtons');
            const hiddenCategoryInput = document.getElementById('billCategory');

            // --- RENDER & UPDATE FUNCTIONS ---
            function renderBills() {
                const container = document.getElementById('billsList');
                const billsToRender = currentBillView === 'upcoming' ? upcomingBills.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)) : paidBills.sort((a,b) => new Date(b.paidDate) - new Date(a.paidDate));
                
                if (billsToRender.length === 0) {
                    container.innerHTML = `<p class="text-center py-8" style="color: var(--cosmic-muted);">No bills in this view.</p>`;
                    return;
                }

                container.innerHTML = billsToRender.map(bill => {
                    // MODIFIED: Changed currency display to INR format
                    const formattedAmount = `‚Çπ${bill.amount.toLocaleString('en-IN')}`;
                    if (currentBillView === 'upcoming') {
                        const dueDate = new Date(bill.dueDate);
                        const today = new Date();
                        today.setHours(0,0,0,0);
                        const billDueDate = new Date(dueDate.valueOf());
                        billDueDate.setHours(0,0,0,0);

                        const diffTime = billDueDate - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        let dueDateText = `Due in ${diffDays} days`; let dueColor = 'var(--cosmic-muted)';
                        if (diffDays < 0) { dueDateText = `Overdue by ${Math.abs(diffDays)} days`; dueColor = 'var(--cosmic-error)'; } 
                        else if (diffDays <= 3) { dueDateText = `Due in ${diffDays} days`; dueColor = 'var(--cosmic-warning)'; } 
                        else if (diffDays === 0) { dueDateText = 'Due Today'; dueColor = 'var(--cosmic-error)'; }

                        return `<article class="flex items-center justify-between p-3 rounded-lg hover:bg-white/5"><div class="flex items-center space-x-4"><div class="w-10 h-10 rounded-full flex items-center justify-center bg-purple-500/20"><svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div><div><div class="flex items-center gap-2"><p class="font-medium">${bill.name}</p><span class="tag">${bill.category}</span></div><p class="text-sm font-medium" style="color: ${dueColor};">${dueDateText}</p></div></div><div class="text-right"><p class="font-semibold text-lg">${formattedAmount}</p><button class="btn-secondary pay-bill-btn text-xs" data-id="${bill.id}">Pay Now</button></div></article>`;
                    } else { // History View
                        return `<article class="flex items-center justify-between p-3 rounded-lg opacity-70"><div class="flex items-center space-x-4"><div class="w-10 h-10 rounded-full flex items-center justify-center bg-green-500/20"><svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><div><div class="flex items-center gap-2"><p class="font-medium">${bill.name}</p><span class="tag">${bill.category}</span></div><p class="text-sm font-medium" style="color: var(--cosmic-muted);">Paid on ${new Date(bill.paidDate).toLocaleDateString()}</p></div></div><p class="font-semibold text-lg">${formattedAmount}</p></article>`;
                    }
                }).join('');
            }
            
            function updatePage() {
                const totalDue = upcomingBills.reduce((sum, bill) => sum + bill.amount, 0);
                // MODIFIED: Changed currency display to INR format
                document.getElementById('totalDueAmount').textContent = totalDue.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });
                document.getElementById('pointsDisplay').textContent = userPoints.toLocaleString();
                renderBills();
                localStorage.setItem('upcomingBills', JSON.stringify(upcomingBills));
                localStorage.setItem('paidBills', JSON.stringify(paidBills));
                localStorage.setItem('transactions', JSON.stringify(transactions));
                localStorage.setItem('userPoints', JSON.stringify(userPoints));
            }

            // --- EVENT LISTENERS ---
            document.getElementById('billForm').addEventListener('submit', (e) => {
                e.preventDefault();
                if (!hiddenCategoryInput.value) {
                    showMessage({ text: 'Please select a category.', type: 'error' });
                    return;
                }
                upcomingBills.push({ id: Date.now(), name: document.getElementById('billName').value, amount: parseFloat(document.getElementById('billAmount').value), dueDate: document.getElementById('billDueDate').value, category: hiddenCategoryInput.value });
                updatePage();
                e.target.reset();
                resetCategoryButtons();
                billModal.close();
                showMessage({ text: 'Bill added successfully!', type: 'success' });
            });

            document.getElementById('billsList').addEventListener('click', (e) => {
                if (e.target.classList.contains('pay-bill-btn')) {
                    const billId = parseInt(e.target.dataset.id, 10);
                    const billToPay = upcomingBills.find(b => b.id === billId);
                    if (billToPay) {
                        const newTransaction = { id: Date.now(), desc: `Payment: ${billToPay.name}`, amount: -billToPay.amount, type: 'expense', tag: billToPay.category, date: new Date().toISOString() };
                        transactions.unshift(newTransaction);
                        upcomingBills = upcomingBills.filter(b => b.id !== billId);
                        billToPay.paidDate = new Date().toISOString();
                        paidBills.unshift(billToPay);
                        userPoints += 25;
                        updatePage();
                        showMessage({
                            text: `${billToPay.name} paid! +25 Points`, type: 'success',
                            button: { text: 'Print Receipt', action: () => { const receiptHTML = generateReceiptHTML(billToPay, newTransaction.id); document.getElementById('print-container').innerHTML = receiptHTML; window.print(); } }
                        });
                    }
                }
            });

            document.getElementById('billTabs').addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    currentBillView = e.target.dataset.view;
                    renderBills();
                }
            });
            
            categoryButtonsContainer.addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    categoryButtonsContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    hiddenCategoryInput.value = e.target.dataset.value;
                }
            });
            const resetCategoryButtons = () => {
                categoryButtonsContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                hiddenCategoryInput.value = '';
            };
            document.getElementById('cancelBillBtn').addEventListener('click', () => { resetCategoryButtons(); billModal.close(); });
            
            // --- UTILITIES & THEME ---
            const themeToggle = document.getElementById('themeToggle');
            if (localStorage.getItem('theme') === 'light') { document.body.setAttribute('data-theme', 'light'); }
            themeToggle.addEventListener('click', () => {
                if (document.body.hasAttribute('data-theme')) { document.body.removeAttribute('data-theme'); localStorage.removeItem('theme'); } 
                else { document.body.setAttribute('data-theme', 'light'); localStorage.setItem('theme', 'light'); }
            });

            function showMessage(options) {
                const box = document.getElementById('messageBox'); box.innerHTML = `<span>${options.text}</span>`;
                if (options.button) { const btn = document.createElement('button'); btn.textContent = options.button.text; btn.onclick = options.button.action; box.appendChild(btn); }
                box.className = `message-box ${options.type || 'success'} show`;
                setTimeout(() => box.classList.remove('show'), 5000);
            }
            function generateReceiptHTML(bill, transactionId) {
                const now = new Date();
                // MODIFIED: Changed currency display to INR format
                const formattedAmount = `‚Çπ${bill.amount.toLocaleString('en-IN')}`;
                return `<div style="font-family: Arial, sans-serif; padding: 2rem; color: #000;"><div style="text-align: center; margin-bottom: 2rem;"><h1 style="font-size: 2rem; font-weight: bold; color: #16213e;">Spendy</h1><p style="font-size: 1.2rem; color: #555;">Payment Receipt</p></div><p><strong>Transaction ID:</strong> ${transactionId}</p><p><strong>Payment Date:</strong> ${now.toLocaleString()}</p><hr style="margin: 1.5rem 0; border-top: 1px dashed #ccc;"><h2 style="font-size: 1.2rem; color: #333; margin-bottom: 1rem;">Payment Details</h2><table style="width: 100%; border-collapse: collapse;"><tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Biller / Service</td><td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">${bill.name}</td></tr><tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Category</td><td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">${bill.category}</td></tr><tr><td style="padding: 8px; font-weight: bold;">Amount Paid</td><td style="padding: 8px; text-align: right; font-weight: bold; font-size: 1.1rem;">${formattedAmount}</td></tr></table><hr style="margin: 1.5rem 0; border-top: 1px dashed #ccc;"><p style="text-align: center; color: #777; font-size: 0.9rem;">Thank you for your payment!</p></div>`;
            }
            function createStarfield() {
                const container = document.getElementById('starfield');
                if (container && container.children.length === 0) {
                    for (let i = 0; i < 150; i++) {
                        const star = document.createElement('div');
                        star.className = 'star';
                        star.style.left = `${Math.random() * 100}%`;
                        star.style.top = `${Math.random() * 100}%`;
                        const size = Math.random() * 1.5 + 1;
                        star.style.width = `${size}px`; star.style.height = star.style.width;
                        star.style.animationDelay = `${Math.random() * 3}s`;
                        container.appendChild(star);
                    }
                }
            }
            function createShootingStars() {
                const container = document.getElementById('shooting-stars');
                if (!container) return;
                setInterval(() => {
                    if (document.body.getAttribute('data-theme') === 'light') return;
                    const star = document.createElement('div');
                    star.className = 'shooting-star';
                    const startX = Math.random() * window.innerWidth;
                    const startY = Math.random() * window.innerHeight * 0.5;
                    const duration = Math.random() * 2 + 1;
                    star.style.setProperty('--start-x', `${startX}px`);
                    star.style.setProperty('--start-y', `${startY}px`);
                    star.style.setProperty('--end-x', `${startX - 300}px`);
                    star.style.setProperty('--end-y', `${startY + 300}px`);
                    star.style.animationDuration = `${duration}s`;
                    container.appendChild(star);
                    setTimeout(() => star.remove(), duration * 1000);
                }, 3000);
            }
            
            // --- INITIALIZATION ---
            const todayStr = new Date().toISOString().split('T')[0];
            document.getElementById('billDueDate').setAttribute('min', todayStr);
            resetCategoryButtons();
            createStarfield();
            createShootingStars();
            updatePage();
        });
    </script>
</body>
</html>